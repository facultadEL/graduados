<html>
<head>
<title> Listado de Graduados </title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="css/bootstrap-theme.min.css">
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/printThis.js"></script>
<script>

var orden = 0;
var interesados;
var searchWord = '';
var etapa = 0;
var interesadosToShow;

function cargarInteresados()
{
	$.ajax({
		type : 'POST',
		url : 'traerDatosGraduado.php',
		success: function(response)
		{
			parseInteresados(response);
			//$('#cuerpoTabla').html(response);
		},
		error: function(msg)
		{
			alert(msg);
		}
	});
}

function parseInteresados(r)
{
	interesados = JSON.parse(r);

	showInteresados();
}

function showInteresados()
{
	interesadosToShow = [];
	datoEtapa = '';

	var l = interesados.length;

	for(var i = 0; i < l; i++)
	{
		if(inSearch(interesados[i]))
		{
			interesadosToShow.push(interesados[i]);
		}
	}

	loadTable();
}

function loadTable()
{
	var l = interesadosToShow.length;

	var htmlToAdd = '';

	for(var i = 0; i < l; i++)
	{
		var a = interesadosToShow[i];

		var vF = a.fechaRegistro.split('-');

		htmlToAdd += `<tr>`;
		htmlToAdd += `<td>${a.apellido}, ${a.nombre}</td>`;
		htmlToAdd += `<td>${a.caracteristicaCel} - ${a.telefonoCel}</td>`;
		htmlToAdd += `<td>${a.caracteristicaCasa} - ${a.telefonoCasa}</td>`;
		htmlToAdd += `<td>${a.mail}</td>`;
		htmlToAdd += `<td>${a.localidad}</td>`;
		htmlToAdd += `<td>${a.cursos}</td>`;
		htmlToAdd += `<td>${vF[2]}/${vF[1]}/${vF[0]}</td>`;
		htmlToAdd += `<td><button type="button" class="btn btn-default" onclick="openModalAnular('${i}')"><span class="glyphicon glyphicon-remove-circle" aria-hidden="true"></span></button></td>`;
		htmlToAdd += `</tr>`;
	}

	$('#cuerpoTabla').html(htmlToAdd);
}

function openModalAnular(index)
{
	var htmlModal = '';
	var cursosInteresado = interesadosToShow[index].cursos.split('<br />');
	var lengthCursos = cursosInteresado.length;
	
	htmlModal += `<input type="hidden" id="cantCursosInteresado" value="${lengthCursos}" />`;
	htmlModal += `<input type="hidden" id="indexInteresado" value="${index}" />`;
	htmlModal += `<div class="row"><div class="form-group"><label for="check0" class="control-label col-xs-12 col-sm-12 col-md-12 col-lg-12 text-center"><input name="check0" type="checkbox" id="check0" onclick="checkAll()"/> Todos</label></div></div>`;
	for(var i = 1; i <= lengthCursos; i++)
	{
		htmlModal += `<div class="row"><div class="form-group"><label for="check${i}" class="control-label col-xs-12 col-sm-12 col-md-12 col-lg-12 text-center"><input name="check${i}" type="checkbox" id="check${i}" class="checkCurso" /> ${cursosInteresado[(i - 1)]}</label></div></div>`;
	}

	$('#modalBody').html(htmlModal);

	$('#myModal').modal('show');
}

function confirmarAnular()
{
	var cant = $('#cantCursosInteresado').val();
	var indexInt = $('#indexInteresado').val();

	var idInteresado = interesadosToShow[indexInt].id;
	var cursosInt = interesadosToShow[indexInt].cursos.split('<br />');

	var vCursos = [];

	for(var i = 1; i <= cursosInt.length; i++)
	{
		var nameChk = `#check${i}`;
		if($(nameChk).is(':checked'))
		{
			vCursos.push(cursosInt[(i-1)]);
		}
	}

	var cursosToSend = '';
	var cantCursos = vCursos.length;
	if(cantCursos > 0)
	{
		for(var i = 0; i < cantCursos; i++)
		{
			cursosToSend += vCursos[i];
			if(i < (cantCursos - 1))
			{
				cursosToSend += '/--/';
			}
		}

		var param = {
			'id': idInteresado,
			'cursos':cursosToSend
		};

		$.ajax({
			type:'POST',
			url:'anularInteresados.php',
			data:param,
			success:function(response)
			{
				if(response[response.length - 1] == '1')
				{
					cargarInteresados();
				}
				else
				{
					alert('Error al anular interesado');
				}
			},
			error: function(msg)
			{
				alert(`Contactese con el administrador. Error: ${msg}`);
			}
		});

	}

	$('#myModal').modal('hide');

}

function checkAll()
{
	var check = $('#check0').is(':checked');
	if(check)
	{
		$('.checkCurso').prop('checked',true);
	}
	else
	{
		$('.checkCurso').prop('checked',false);
	}
}

function formatDate(d)
{
	var vD = d.split('-');
	var dateToReturn = vD[2]+'/'+vD[1]+'/'+vD[0];
	return dateToReturn;
}


function inSearch(a)
{
	if((a.nombre.toLowerCase().indexOf(searchWord) == -1) && (a.apellido.toLowerCase().indexOf(searchWord) == -1) && (a.cursos.toLowerCase().indexOf(searchWord) == -1) && (a.localidad.toLowerCase().indexOf(searchWord) == -1))
	{
		return false;
	}
	else
	{
		return true;
	}
}

function printMe()
{
	var data = '';
	for(var i = 0; i < interesadosToShow.length;i++)
	{
		var a = interesadosToShow[i];
		var vF = a.fechaRegistro.split('-');
		data += `${a.apellido}, ${a.nombre}/-/${a.caracteristicaCel} - ${a.telefonoCel}/-/${a.caracteristicaCasa} - ${a.telefonoCasa}/-/${a.mail}/-/${a.localidad}/-/${a.cursos}/-/${vF[2]}/${vF[1]}/${vF[0]}`;

		if(i < interesadosToShow.length - 1)
		{
			data += '/-/-/';
		}
	}

	var url = `excelInteresados.php?d=${data}`;

	window.open(url,'_blank');
}

function searchControl()
{
	searchWord = $('#searchWord').val().toLowerCase();
	showInteresados();
}

$(document).ready(function(){
	cargarInteresados();
});

</script>
</head>
<body>
	<div class="container">
		<div class="table-responsive">
			<table class="table table-striped table-hover printThis">
				<thead>
					<tr>
						<td colspan="8" class="text-center resizeTable">
							<strong>Listado de Graduados</strong>
						</td>
					</tr>
					<tr>
						<td colspan="8" class="text-center resizeTable" align="center">
							<div class="input-group" style="width:100%">
								<input type="text" class="form-control" placeholder="Buscar..." id="searchWord" onkeyup="searchControl()">
								<span class="input-group-btn">
									<button class="btn btn-default" type="button">Buscar</button>
									<button class="btn btn-default" type="button" onclick="printMe()">Imprimir</button>
								</span>
							</div>
						</td>
					</tr>
					<tr>
						<td><strong>#</strong></td>
						<td><strong>Graduado</strong></td>
						<td><strong>Mail</strong></td>
						<td><strong>Telefono</strong></td>
						<td><strong>Suscrito</strong></td>
					</tr>
				</thead>
				<tbody id="cuerpoTabla">
					
				</tbody>
			</table>
		</div>
	</div>
</body>
</html>